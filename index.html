<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BoringClicker</title>
<style>
  :root{
    --bg1: rgba(15,23,36,0.72);
    --bg2: rgba(16,42,67,0.72);
    --glass-border: rgba(255,255,255,0.06);
    --muted: #bfc9d9;
    --glass-radius: 14px;
    --accent1: #ffd36b;
    --accent2: #ff8ab6;
    --buy-active: linear-gradient(90deg,var(--accent1),var(--accent2));
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{
    background:
      radial-gradient(1200px 600px at 10% 10%, rgba(255,138,182,0.06), transparent 8%),
      linear-gradient(180deg, var(--bg1), var(--bg2)),
      url('SpaceBackground.jfif');
    background-blend-mode: overlay, overlay, normal;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    color:#e6eef8;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:18px;
    min-height:100vh;
    gap:12px;
  }

  /* TOP BAR (export/import code) */
  #topBar{
    position:fixed;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    z-index:10001;
    width:88%;
    max-width:1200px;
    display:flex;
    gap:8px;
    align-items:center;
    padding:10px 12px;
    background: rgba(4,12,24,0.6);
    border:1px solid rgba(255,255,255,0.04);
    border-radius:12px;
    backdrop-filter: blur(6px);
  }
  #exportCode{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#eaf2ff}
  #importInput{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#eaf2ff}
  .topBtn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#eaf2ff;cursor:pointer;font-weight:700}
  .topBtn.positive{background:var(--buy-active);color:#082032;border:none}

  /* Settings button (top-right) */
  #settingsBtn{
    position:fixed;
    top:12px;
    right:14px;
    z-index:9998;
    background: rgba(0,0,0,0.28);
    border:1px solid rgba(255,255,255,0.06);
    color:#eaf2ff;
    padding:10px 12px;
    border-radius:10px;
    cursor:pointer;
    backdrop-filter: blur(4px);
    box-shadow: 0 6px 18px rgba(2,6,23,0.6);
    font-weight:700;
  }

  /* Loading overlay */
  #loadingOverlay{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:linear-gradient(180deg, rgba(2,6,23,0.92), rgba(2,6,23,0.95));
    z-index:9999;
    flex-direction:column;
    gap:18px;
    color:#eaf2ff;
  }
  #loadingBox{width:520px;max-width:90%;padding:18px;border-radius:12px;background: rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);text-align:center}
  #loadingBarWrap{width:100%;background: rgba(255,255,255,0.03);border-radius:12px;padding:6px;margin-top:12px}
  #loadingBar{height:14px;width:0%;border-radius:8px;background: linear-gradient(90deg, var(--accent1), var(--accent2));transition: width 300ms ease}

  /* Main container */
  #main{
    width:100%;
    max-width:1200px;
    display:flex;
    gap:20px;
    align-items:flex-start;
    margin-top:70px;
  }

  .panel{background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border:1px solid var(--glass-border);backdrop-filter: blur(6px);padding:18px;border-radius: var(--glass-radius);box-shadow: 0 8px 30px rgba(2,6,23,0.55);}

  /* Left column */
  #leftCol{width:420px;display:flex;flex-direction:column;gap:12px}
  .titleRow{display:flex;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:20px}
  .sub{color:var(--muted);font-size:13px}
  #totalCookies{font-size:34px;margin-top:6px;font-weight:700;color:#fff;text-shadow: 0 6px 18px rgba(0,0,0,0.6);}

  .metaRow{display:flex;gap:10px;margin-top:6px}
  .meta{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border: 1px solid rgba(255,255,255,0.03);padding:10px 12px;border-radius:10px;font-size:13px;min-width:120px;text-align:left}
  .meta strong{display:block;font-size:15px;color:#fff}

  /* Upgrades list */
  #upgradesList{display:flex;flex-direction:column;gap:8px;margin-top:6px;max-height:260px;overflow:auto;padding-right:8px}
  .upgradeItem{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.015)}
  .upgradeItem .left{display:flex;flex-direction:column}
  .upgradeItem .name{font-weight:800}
  .upgradeItem .desc{font-size:12px;color:var(--muted)}
  .upgradeItem button{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#eaf2ff;cursor:pointer}
  .upgradeItem button.bought{background:rgba(255,255,255,0.06);color:var(--muted);cursor:default;border:none}

  /* Multi-buy */
  #multiBuyWrap{display:flex;gap:8px;align-items:center;margin-top:8px}
  .multiBtn{padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#eaf2ff;cursor:pointer;font-weight:700}
  .multiBtn.active{background:var(--buy-active);color:#082032;border:none;box-shadow:0 6px 22px rgba(255,138,182,0.06)}

  /* Buildings */
  #buildingsList{margin-top:6px;display:flex;flex-direction:column;gap:10px;max-height:420px;overflow-y:auto;padding-right:8px}
  #buildingsList::-webkit-scrollbar{width:10px} #buildingsList::-webkit-scrollbar-track{background:transparent}
  #buildingsList::-webkit-scrollbar-thumb{background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));border-radius:10px;border:2px solid transparent;background-clip:padding-box}
  .building{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.015);gap:10px}
  .b-left{display:flex;gap:10px;align-items:center}
  .b-icon{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#082032;box-shadow:0 6px 18px rgba(255,138,182,0.08)}
  .b-info{display:flex;flex-direction:column}
  .b-info .name{font-weight:800}
  .b-info .desc{font-size:12px;color:var(--muted)}
  .b-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
  .b-cost{font-size:13px;color:var(--muted)}
  .buyBtn{background:transparent;border:1px solid rgba(255,255,255,0.08);color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:700}
  .buyBtn.buyable{background:var(--buy-active);color:#082032;border:none;box-shadow:0 6px 22px rgba(255,138,182,0.12)}

  /* Right column */
  #rightCol{flex:1;display:flex;flex-direction:column;gap:12px}
  #starCard{display:flex;flex-direction:column;align-items:center;padding:20px;border-radius:18px;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 40px rgba(2,6,23,0.55)}
  #starName{font-weight:800;margin-bottom:10px;color:#fff}
  #cookieBtn{width:280px;max-width:60%;cursor:pointer;user-select:none;transform-origin:center;transition: transform .12s ease, filter .12s ease}
  #cookieBtn:hover{ transform:translateY(-6px) rotate(-2deg) }
  #cookieBtn:active{ transform:scale(.94) rotate(0deg) }
  #starStats{margin-top:14px;display:flex;gap:18px;align-items:center;justify-content:center}
  .stat{text-align:center;padding:8px 14px;border-radius:12px;background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);min-width:140px}
  .stat .label{ font-size:12px; color:var(--muted); }
  .stat .value{ margin-top:6px; font-size:18px; font-weight:800; color:#fff}

  /* Settings modal */
  #settingsModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:99999}
  #settingsCard{background:#071025;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);width:420px;max-width:92%}
  #settingsCard h3{margin:0 0 8px 0}
  .row{display:flex;align-items:center;justify-content:space-between;margin-top:10px;gap:12px}
  .row label{font-size:13px;color:var(--muted);min-width:140px}
  input[type="range"]{width:100%}
  input[type="text"]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#eaf2ff}

  /* Confirm wipe */
  #confirmWipe{display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:100000}
  #confirmCard{background:#071025;padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);width:360px;text-align:center}
  #confirmCard button{margin:8px;padding:8px 12px;border-radius:8px}

  @media (max-width:1100px){
    body{padding:12px}
    #topBar{width:95%}
    #main{flex-direction:column;align-items:center;margin-top:120px}
    #leftCol{width:100%;max-width:760px}
    #rightCol{width:100%}
    #cookieBtn{width:220px}
  }
</style>
</head>
<body>
  <!-- TOP BAR: export / import code -->
  <div id="topBar">
    <input id="exportCode" readonly aria-label="Export code" title="Copy/export code (share to other device)">
    <button id="copyCodeBtn" class="topBtn">Copy code</button>
    <input id="importInput" placeholder="Paste import code here..." aria-label="Import code">
    <button id="importBtn" class="topBtn">Load code</button>
  </div>

  <button id="settingsBtn" aria-haspopup="dialog">⚙ Settings</button>

  <!-- Loading -->
  <div id="loadingOverlay" role="status" aria-live="polite">
    <div id="loadingBox">
      <div style="font-size:20px;font-weight:800">BoringClicker</div>
      <div style="margin-top:8px;color:var(--muted)">Loading assets — please wait</div>
      <div id="loadingBarWrap"><div id="loadingBar"></div></div>
      <div id="loadingPercent" style="margin-top:8px;color:var(--muted)">0%</div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div id="settingsCard" class="panel">
      <h3>Settings</h3>
      <div style="font-size:13px;color:var(--muted)">Adjust sound volume and rename your StarCollector. Save/export options below.</div>

      <div class="row" style="margin-top:12px">
        <label for="volumeRange">Sound Volume</label>
        <input id="volumeRange" type="range" min="0" max="100" step="1" value="80" />
      </div>

      <div class="row">
        <label for="nameInput">StarCollector name</label>
        <input id="nameInput" type="text" maxlength="20" placeholder="StarCollector" />
      </div>

      <div style="display:flex;gap:8px;justify-content:space-between;margin-top:12px">
        <button id="saveNow" class="buyBtn">Save Now</button>
        <button id="wipeBtn" class="buyBtn" style="background:transparent;border:1px solid rgba(255,80,80,0.1);color:#ffb3b3">Wipe Save</button>
        <button id="settingsClose" class="buyBtn">Close</button>
      </div>
    </div>
  </div>

  <!-- Confirm Wipe -->
  <div id="confirmWipe" role="dialog" aria-modal="true">
    <div id="confirmCard">
      <div style="font-weight:800;font-size:16px;margin-bottom:8px">Confirm wipe</div>
      <div style="color:var(--muted);margin-bottom:12px">Are you sure you want to delete your save? This cannot be undone.</div>
      <div>
        <button id="confirmWipeYes" class="buyBtn" style="background:linear-gradient(90deg,#ff8a8a,#ff5a5a);color:#082032">Yes, wipe</button>
        <button id="confirmWipeNo" class="buyBtn" style="margin-left:8px">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div id="main">
    <div id="leftCol">
      <div class="panel">
        <div class="titleRow">
          <div>
            <h1>BoringClicker</h1>
            <div class="sub">Buy space things — produce cookies per second</div>
          </div>
          <div class="sub" style="text-align:right">v1.6+</div>
        </div>

        <div id="totalCookies">0</div>

        <div class="metaRow">
          <div class="meta"><div class="label">Cookies</div><strong id="metaTotal">0</strong><div class="cost">Available cookies</div></div>
          <div class="meta"><div class="label">Session</div><strong id="metaSession">0</strong><div class="cost">This session</div></div>
        </div>

        <div style="margin-top:8px">
          <div class="sub" style="margin-bottom:6px">Upgrades (one-time)</div>
          <div id="upgradesList" aria-live="polite"></div>
        </div>

        <div id="multiBuyWrap"><div class="sub">Buy amount:</div>
          <button class="multiBtn active" data-mult="1">x1</button>
          <button class="multiBtn" data-mult="10">x10</button>
          <button class="multiBtn" data-mult="100">x100</button>
          <button class="multiBtn" data-mult="max">Max</button>
        </div>

        <div style="margin-top:12px">
          <div class="sub" style="margin-bottom:6px">Buildings</div>
          <div id="buildingsList" role="list"></div>
        </div>

        <div style="margin-top:10px;color:var(--muted);font-size:13px">Tip: Use the export code above to move progress between devices.</div>
      </div>
    </div>

    <div id="rightCol">
      <div id="starCard" class="panel">
        <div id="starName">StarCollector</div>
        <img id="cookieBtn" src="StarClickMain.png" alt="StarClickMain" draggable="false">
      </div>

      <div id="starStats">
        <div class="stat"><div class="label">Cookies / second</div><div class="value" id="cpsValue">0</div></div>
        <div class="stat"><div class="label">Cookies / click</div><div class="value" id="cpcValue">1</div></div>
      </div>
    </div>
  </div>

<script>
/* BoringClicker — v1.6+ (upgrades + export/import code)
   - New: many one-time upgrades (balanced)
   - Export code (copy at top) — base64 JSON string of save (cookies, upgrades, buildings, settings)
   - Import paste field at top (Load code) — overwrites current save after confirm
   - Save/load (localStorage), autosave, wipe with confirm
   - Multibuy buttons, rate-limited click sounds, settings modal
*/

// ---------- CONFIG & SAVE KEYS ----------
const SAVE_KEY = 'bc_save_v2';
const LS_VOLUME = 'bc_volume_v2';
const LS_NAME = 'bc_name_v2';

// ---------- ASSETS LOADING ----------
const assets = ['StarClickMain.png','SpaceBackground.jfif','ClickSound.mp3'];
let assetsLoaded = 0;
const loadingOverlay = document.getElementById('loadingOverlay');
const loadingBar = document.getElementById('loadingBar');
const loadingPercent = document.getElementById('loadingPercent');
const gameWrap = document.getElementById('main');

let clickAudio = new Audio('ClickSound.mp3');
clickAudio.preload = 'auto';
clickAudio.crossOrigin = 'anonymous';
clickAudio.addEventListener('canplaythrough', ()=>{ assetsLoaded++; updateLoadingProgress(); revealIfReady(); }, { once:true });
clickAudio.addEventListener('error', ()=>{ assetsLoaded++; updateLoadingProgress(); revealIfReady(); }, { once:true });

assets.filter(a => a.endsWith('.png') || a.endsWith('.jfif')).forEach(src=>{
  const img = new Image();
  img.src = src;
  img.onload = ()=>{ assetsLoaded++; updateLoadingProgress(); revealIfReady(); };
  img.onerror = ()=>{ assetsLoaded++; updateLoadingProgress(); revealIfReady(); };
});
function updateLoadingProgress(){ const pct = Math.round((assetsLoaded / assets.length) * 100); loadingBar.style.width = pct + '%'; loadingPercent.textContent = pct + '%'; }
function revealIfReady(){
  if (assetsLoaded >= assets.length){
    // load saved game before revealing UI
    loadGame();
    setTimeout(()=>{ loadingOverlay.style.opacity=0; setTimeout(()=>loadingOverlay.remove(),420); gameWrap.style.visibility='visible'; refreshUI(); generateExportCode(); }, 300);
  }
}
setTimeout(()=>{ if (assetsLoaded < assets.length) { assetsLoaded = Math.min(assets.length, assetsLoaded+1); updateLoadingProgress(); revealIfReady(); } }, 2000);

/* ---------- GAME STATE ---------- */
let cookies = 0;
let sessionCookies = 0;
let cookiesPerClick = 1;
let clickUpgradeLevel = 0;
let effUpgradeLevel = 0;

// extra system variables affected by upgrades
let buildingMultiplier = 1.0;   // multiplies building CPS
let costMultiplier = 1.0;       // multiplies base building cost
let globalCPSBonus = 0;         // flat CPS added
let globalCookieMultiplier = 1.0; // multiplies final cookie gains (not used for purchases)

// BUILDINGS — easy to add via initialBuildings array
const initialBuildings = [
  { id:'telescope', name:'Telescope', baseCost:15, baseCPS:0.1, desc:'Basic science: small CPS' },
  { id:'space_rocket', name:'Space Rocket', baseCost:200, baseCPS:1.25, desc:'Rockets launching probes' },
  { id:'satellite', name:'Satellite', baseCost:1100, baseCPS:9, desc:'Orbiting machines, steady income' },
  { id:'space_station', name:'Space Station', baseCost:12000, baseCPS:48, desc:'Big orbital platform' },
  { id:'solar_probe', name:'Solar Probe', baseCost:130000, baseCPS:270, desc:'Expensive probes near stars' },
  { id:'tiny_planet', name:'Tiny Planet', baseCost:1400000, baseCPS:1450, desc:'Small artificial world' },
  { id:'gas_giant', name:'Gas Giant', baseCost:20000000, baseCPS:7800, desc:'Huge yields but very expensive' },
  { id:'alien_megaplanet', name:'Alien MegaPlanet', baseCost:330000000, baseCPS:44000, desc:'Mega investment: massive CPS' }
];

let buildingDefs = [];
const buildingsState = {}; // each: {owned}

function registerBuilding(def){ buildingDefs.push(Object.assign({},def)); buildingsState[def.id] = buildingsState[def.id] || {owned:0}; }
initialBuildings.forEach(b=>registerBuilding(b));

// UPGRADES (one-time purchases, not OP)
// Each upgrade has id,name,desc,cost,apply(state) which applies its effect when bought
const upgradesDefs = [
  { id:'u_click_1', name:'Click +1', desc:'+1 cookies per click', cost:500, apply:()=> { cookiesPerClick += 1; } },
  { id:'u_click_5', name:'Click +5', desc:'+5 cookies per click', cost:2500, apply:()=> { cookiesPerClick += 5; } },
  { id:'u_click_double', name:'Click Doubler', desc:'Double your cookies-per-click', cost:20000, apply:()=> { cookiesPerClick = Math.round(cookiesPerClick * 2); } },
  { id:'u_build_10', name:'Engine Tuning', desc:'+10% building CPS', cost:10000, apply:()=> { buildingMultiplier += 0.10; } },
  { id:'u_build_50', name:'Quantum Efficiency', desc:'+50% building CPS', cost:75000, apply:()=> { buildingMultiplier += 0.50; } },
  { id:'u_auto_2', name:'Auto Core', desc:'+2 flat CPS (always on)', cost:12000, apply:()=> { globalCPSBonus += 2; } },
  { id:'u_global_5', name:'Harvest Protocol', desc:'+5% overall cookie gain', cost:30000, apply:()=> { globalCookieMultiplier *= 1.05; } },
  { id:'u_cost_down', name:'Manufacturing Discount', desc:'-7% building base cost', cost:20000, apply:()=> { costMultiplier *= 0.93; } },
  { id:'u_build_special', name:'Advanced Modules', desc:'+20% CPS for small buildings', cost:50000, apply:()=> { /* special: boost telescopes & rockets */ 
      buildingDefs.forEach(d=>{ if (d.id==='telescope'||d.id==='space_rocket') d.baseCPS = d.baseCPS * 1.2; });
    } 
  },
  { id:'u_click_small', name:'Finger Training', desc:'+2 cookies per click', cost:6000, apply:()=> { cookiesPerClick += 2; } },
  { id:'u_mini_boost', name:'Micro Boost', desc:'+200 cookies (one-time bonus)', cost:15000, apply:()=> { cookies += 200; } },
  { id:'u_build_multi', name:'Structural Upgrade', desc:'+15% building CPS', cost:40000, apply:()=> { buildingMultiplier += 0.15; } }
];
// purchased set
const purchasedUpgrades = new Set();

// ---------- UI Refs ----------
const totalEl = document.getElementById('totalCookies');
const metaTotal = document.getElementById('metaTotal');
const metaSession = document.getElementById('metaSession');
const cpsEl = document.getElementById('cpsValue');
const cpcEl = document.getElementById('cpcValue');
const btn = document.getElementById('cookieBtn');
const buildingsList = document.getElementById('buildingsList');
const upgradesListEl = document.getElementById('upgradesList');
const starNameEl = document.getElementById('starName');
const exportCodeInput = document.getElementById('exportCode');
const copyCodeBtn = document.getElementById('copyCodeBtn');
const importInput = document.getElementById('importInput');
const importBtn = document.getElementById('importBtn');

const buyClickUpgradeBtn = document.getElementById('buyClickUpgrade');
const buyEffUpgradeBtn = document.getElementById('buyEffUpgrade');

const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const settingsClose = document.getElementById('settingsClose');
const volumeRange = document.getElementById('volumeRange');
const nameInput = document.getElementById('nameInput');
const saveNowBtn = document.getElementById('saveNow');
const wipeBtn = document.getElementById('wipeBtn');
const confirmWipe = document.getElementById('confirmWipe');
const confirmWipeYes = document.getElementById('confirmWipeYes');
const confirmWipeNo = document.getElementById('confirmWipeNo');

let multiBuy = 1;
document.querySelectorAll('.multiBtn').forEach(b=>{
  b.addEventListener('click', ()=>{ document.querySelectorAll('.multiBtn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); const v = b.dataset.mult; multiBuy = (v==='max')? 'max' : Number(v); });
});

// ---------- SETTINGS & PERSISTENT VALUES ----------
let volume = Number(localStorage.getItem(LS_VOLUME) ?? 80) / 100;
let starName = localStorage.getItem(LS_NAME) ?? 'StarCollector';
volumeRange.value = Math.round(volume*100);
nameInput.value = starName;
starNameEl.textContent = starName;

volumeRange.addEventListener('input',(e)=>{ volume = Number(e.target.value)/100; localStorage.setItem(LS_VOLUME, Math.round(volume*100)); clickAudio.volume = volume; generateExportCode(); saveGame(); });
nameInput.addEventListener('input',(e)=>{ starName = e.target.value.slice(0,20) || 'StarCollector'; starNameEl.textContent = starName; localStorage.setItem(LS_NAME, starName); generateExportCode(); saveGame(); });
settingsBtn.addEventListener('click', ()=>{ settingsModal.style.display='flex'; settingsModal.setAttribute('aria-hidden','false'); });
settingsClose.addEventListener('click', ()=>{ settingsModal.style.display='none'; settingsModal.setAttribute('aria-hidden','true'); });

// ---------- NUMBER FORMATTING ----------
function formatNumber(n){
  if (!isFinite(n)) return '0';
  const abs = Math.abs(n);
  if (abs < 1000) return Math.floor(n).toString();
  if (abs < 1e6) return Math.floor(n).toLocaleString();
  const millions = n / 1e6;
  if (millions < 1000){ const rounded = Math.round(millions*100)/100; return (Number.isInteger(rounded) ? rounded.toLocaleString() : rounded.toFixed(2)) + ' million'; }
  const roundedMillions = Math.round(millions);
  return roundedMillions.toLocaleString() + ' million';
}

// ---------- FORMULAS ----------
const COST_SCALE = 1.17;
function getBuildingCost(def, owned){ return Math.ceil(def.baseCost * costMultiplier * Math.pow(COST_SCALE, owned)); }
function getClickUpgradeCost(level){ return Math.ceil(8000 * Math.pow(3.2, level)); }
function getEffUpgradeCost(level){ return Math.ceil(25000 * Math.pow(2.8, level)); }
function getBuildingCPS(){
  let total = 0;
  for (const d of buildingDefs) total += buildingsState[d.id].owned * d.baseCPS;
  return total * buildingMultiplier + globalCPSBonus;
}
function getCPS(){ return getBuildingCPS(); }

// ---------- AUDIO RATE LIMITER ----------
let soundTimestamps = [];
clickAudio.volume = volume;
clickAudio.loop = false;
function getMaxSoundsPerSecond(){
  const cps = getCPS();
  const v = 12 - Math.floor(Math.log10(cps + 10));
  return Math.max(1, Math.min(12, v));
}
function playSound(){
  const now = Date.now();
  soundTimestamps = soundTimestamps.filter(t=> (now - t) <= 1000);
  const maxAllowed = getMaxSoundsPerSecond();
  if (soundTimestamps.length >= maxAllowed) return false;
  soundTimestamps.push(now);
  try { const a = clickAudio.cloneNode(); a.volume = volume; a.play().catch(()=>{}); } catch(e){ try { clickAudio.currentTime=0; clickAudio.volume=volume; clickAudio.play().catch(()=>{}); } catch(_){} }
  return true;
}

// ---------- UI RENDER ----------
function renderUpgrades(){
  upgradesListEl.innerHTML = '';
  upgradesDefs.forEach(u=>{
    const bought = purchasedUpgrades.has(u.id);
    const item = document.createElement('div'); item.className='upgradeItem';
    item.innerHTML = `<div class="left"><div class="name">${u.name}</div><div class="desc">${u.desc}</div></div>
      <div><div style="font-size:13px;color:var(--muted);margin-bottom:6px">${formatNumber(u.cost)}</div>
      <button ${bought? 'class="bought" disabled': ''} data-id="${u.id}">${bought ? 'Purchased' : 'Buy'}</button></div>`;
    upgradesListEl.appendChild(item);
  });
  upgradesListEl.querySelectorAll('button').forEach(btn=>{
    const id = btn.dataset.id;
    btn.addEventListener('click', ()=> buyUpgrade(id, btn));
  });
}

function renderBuildings(){
  buildingsList.innerHTML = '';
  buildingDefs.forEach(def=>{
    const state = buildingsState[def.id];
    const cost = getBuildingCost(def, state.owned);
    const effectivePer = (def.baseCPS * buildingMultiplier);
    const b = document.createElement('div'); b.className='building';
    b.innerHTML = `<div class="b-left"><div class="b-icon">${def.name.split(' ').map(s=>s[0]).slice(0,2).join('')}</div>
      <div class="b-info"><div class="name">${def.name}</div><div class="desc">${def.desc}</div></div></div>
      <div class="b-right"><div class="b-cost">Cost: <strong>${formatNumber(cost)}</strong></div>
      <div class="b-cost">Gives: <strong>${Number(effectivePer.toFixed(2))}</strong> CPS each</div>
      <div style="display:flex;gap:8px;align-items:center">
      <div style="font-size:13px;color:var(--muted);">Owned: <strong>${state.owned}</strong></div>
      <button class="buyBtn" data-id="${def.id}" data-cost="${cost}">Buy</button>
      </div></div>`;
    buildingsList.appendChild(b);
  });
  document.querySelectorAll('.buyBtn').forEach(btnEl=>{
    const id = btnEl.dataset.id;
    const cost = Number(btnEl.dataset.cost);
    btnEl.classList.toggle('buyable', cookies >= cost);
    btnEl.onclick = ()=> attemptBuy(id);
  });
}

function refreshUI(){
  totalEl.textContent = formatNumber(Math.floor(cookies));
  metaTotal.textContent = formatNumber(Math.floor(cookies));
  metaSession.textContent = formatNumber(Math.floor(sessionCookies));
  cpsEl.textContent = Number(getCPS().toFixed(2));
  cpcEl.textContent = cookiesPerClick;
  starNameEl.textContent = starName;
  renderUpgrades();
  renderBuildings();
  generateExportCode(); // update code live
}

// ---------- PURCHASES & MULTIBUY ----------
function getCostForN(def, owned, n){
  let total = 0;
  for(let i=0;i<n;i++) total += getBuildingCost(def, owned + i);
  return total;
}
function getMaxAffordable(def, owned, available){
  let n=0, cost=0;
  const cap = 1000000;
  while(n < cap){
    const next = getBuildingCost(def, owned + n);
    if (cost + next <= available){ cost += next; n++; } else break;
  }
  return {count:n, cost};
}
function attemptBuy(id){
  const def = buildingDefs.find(d=>d.id===id);
  if(!def) return;
  const state = buildingsState[id];
  let want = multiBuy === 'max' ? getMaxAffordable(def, state.owned, cookies).count : Number(multiBuy);
  if (!want || want <= 0){ flashButton(document.querySelector(`.buyBtn[data-id="${id}"]`)); return; }
  // cap reasonable to avoid infinite loops
  want = Math.max(1, Math.min(100000, Math.floor(want)));
  const totalCost = getCostForN(def, state.owned, want);
  if (totalCost <= cookies){
    cookies -= totalCost;
    state.owned += want;
    playSound(); refreshUI(); saveGame();
  } else {
    // try smaller: greedy buy as many as possible
    const mx = getMaxAffordable(def, state.owned, cookies);
    if (mx.count > 0){
      cookies -= mx.cost;
      state.owned += mx.count;
      playSound(); refreshUI(); saveGame();
    } else {
      flashButton(document.querySelector(`.buyBtn[data-id="${id}"]`));
    }
  }
}

// upgrade buy (one-time)
function buyUpgrade(id, btnEl){
  const up = upgradesDefs.find(u=>u.id===id);
  if (!up) return;
  if (purchasedUpgrades.has(id)){ return; }
  if (cookies < up.cost){ flashButton(btnEl); return; }
  cookies -= up.cost;
  // apply effect
  try { up.apply(); } catch(e){ console.warn('Upgrade apply error', e); }
  purchasedUpgrades.add(id);
  playSound(); refreshUI(); saveGame();
}

// ---------- CLICK & CPS TICK ----------
btn.addEventListener('click', ()=>{
  btn.style.transform = "scale(0.96)";
  setTimeout(()=> btn.style.transform = "",120);
  const gain = cookiesPerClick * globalCookieMultiplier;
  cookies += gain;
  sessionCookies += gain;
  playSound(); refreshUI(); saveGame();
});
setInterval(()=>{
  const cps = getCPS();
  if (cps > 0){
    cookies += cps * globalCookieMultiplier;
    sessionCookies += cps * globalCookieMultiplier;
    if (cps >= 500) playSound();
    refreshUI(); saveGame();
  } else refreshUI();
},1000);

// ---------- SAVE / LOAD / WIPE ----------
function getSaveData(){
  return {
    version:2,
    ts:Date.now(),
    cookies, sessionCookies, cookiesPerClick, clickUpgradeLevel, effUpgradeLevel,
    buildingMultiplier, costMultiplier, globalCPSBonus, globalCookieMultiplier,
    buildings: Object.fromEntries(Object.entries(buildingsState).map(([k,v])=>[k,v.owned])),
    purchased: Array.from(purchasedUpgrades),
    settings:{volume:Math.round(volume*100), starName}
  };
}
function saveGame(){
  try{ localStorage.setItem(SAVE_KEY, JSON.stringify(getSaveData())); generateExportCode(); } catch(e){ console.warn('Save failed', e); }
}
function loadGame(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    cookies = Number(data.cookies) || 0; sessionCookies = Number(data.sessionCookies) || 0;
    cookiesPerClick = Number(data.cookiesPerClick) || 1;
    clickUpgradeLevel = Number(data.clickUpgradeLevel) || 0;
    effUpgradeLevel = Number(data.effUpgradeLevel) || 0;
    buildingMultiplier = Number(data.buildingMultiplier) || 1.0;
    costMultiplier = Number(data.costMultiplier) || 1.0;
    globalCPSBonus = Number(data.globalCPSBonus) || 0;
    globalCookieMultiplier = Number(data.globalCookieMultiplier) || 1.0;
    if (data.buildings){ for(const [id, n] of Object.entries(data.buildings)){ if (buildingsState[id]) buildingsState[id].owned = Number(n) || 0; } }
    purchasedUpgrades.clear();
    if (Array.isArray(data.purchased)) data.purchased.forEach(id=>purchasedUpgrades.add(id));
    if (data.settings){
      if (typeof data.settings.volume !== 'undefined'){ volume = (Number(data.settings.volume)||80)/100; localStorage.setItem(LS_VOLUME, Math.round(volume*100)); if (typeof volumeRange !== 'undefined') volumeRange.value = Math.round(volume*100); }
      if (typeof data.settings.starName === 'string'){ starName = data.settings.starName || 'StarCollector'; localStorage.setItem(LS_NAME, starName); if (typeof nameInput !== 'undefined') nameInput.value = starName; }
    }
  } catch(e){ console.warn('Load failed', e); }
}

// wipe confirm
document.getElementById('wipeBtn').addEventListener('click', ()=>{ confirmWipe.style.display='flex'; });
confirmWipeNo.addEventListener('click', ()=>{ confirmWipe.style.display='none'; });
confirmWipeYes.addEventListener('click', ()=>{
  localStorage.removeItem(SAVE_KEY); localStorage.removeItem(LS_VOLUME); localStorage.removeItem(LS_NAME);
  // reset core state
  cookies = 0; sessionCookies = 0; cookiesPerClick = 1; clickUpgradeLevel = 0; effUpgradeLevel = 0;
  buildingMultiplier = 1.0; costMultiplier = 1.0; globalCPSBonus = 0; globalCookieMultiplier = 1.0;
  for (const id in buildingsState) buildingsState[id].owned = 0;
  purchasedUpgrades.clear();
  volume = 0.8; localStorage.setItem(LS_VOLUME, Math.round(volume*100)); volumeRange.value = Math.round(volume*100);
  starName = 'StarCollector'; localStorage.setItem(LS_NAME, starName); nameInput.value = starName; starNameEl.textContent = starName;
  clickAudio.volume = volume;
  confirmWipe.style.display='none';
  refreshUI(); saveGame(); generateExportCode();
});

// Save Now
saveNowBtn.addEventListener('click', ()=>{ saveGame(); saveNowBtn.textContent='Saved'; setTimeout(()=>saveNowBtn.textContent='Save Now',900); });

// autosave
setInterval(saveGame, 10000);
window.addEventListener('beforeunload', saveGame);

// ---------- EXPORT / IMPORT CODE ----------
function generateExportCode(){
  const data = getSaveData();
  // JSON -> UTF8 -> base64
  try{
    const json = JSON.stringify(data);
    const b64 = btoa(unescape(encodeURIComponent(json)));
    exportCodeInput.value = b64;
    return b64;
  } catch(e){
    console.warn('Export failed', e);
    exportCodeInput.value = '';
    return '';
  }
}
copyCodeBtn.addEventListener('click', async ()=>{
  const code = exportCodeInput.value;
  if (!code) return;
  try{
    await navigator.clipboard.writeText(code);
    copyCodeBtn.textContent = 'Copied!';
    setTimeout(()=> copyCodeBtn.textContent = 'Copy code', 900);
  } catch(e){
    // fallback select
    exportCodeInput.select();
    document.execCommand('copy');
    copyCodeBtn.textContent = 'Copied!';
    setTimeout(()=> copyCodeBtn.textContent = 'Copy code', 900);
  }
});

// import flow: paste -> parse -> confirm -> apply (overwrites current save)
importBtn.addEventListener('click', ()=>{
  const code = importInput.value.trim();
  if (!code) { alert('Paste a code first'); return; }
  let json = null;
  try{
    const str = decodeURIComponent(escape(atob(code)));
    json = JSON.parse(str);
  } catch(e){
    try { // some older clients may have used direct btoa, attempt a different decode
      const str2 = atob(code);
      json = JSON.parse(str2);
    } catch(err){
      alert('Invalid code — could not parse.');
      return;
    }
  }
  if (!json || typeof json !== 'object'){ alert('Invalid code data'); return; }
  if (!confirm('Importing this code will overwrite your current progress. Proceed?')) return;
  // apply imported data (map fields)
  try{
    cookies = Number(json.cookies) || 0; sessionCookies = Number(json.sessionCookies) || 0;
    cookiesPerClick = Number(json.cookiesPerClick) || 1;
    clickUpgradeLevel = Number(json.clickUpgradeLevel) || 0;
    effUpgradeLevel = Number(json.effUpgradeLevel) || 0;
    buildingMultiplier = Number(json.buildingMultiplier) || 1.0;
    costMultiplier = Number(json.costMultiplier) || 1.0;
    globalCPSBonus = Number(json.globalCPSBonus) || 0;
    globalCookieMultiplier = Number(json.globalCookieMultiplier) || 1.0;
    if (json.buildings && typeof json.buildings === 'object'){
      for (const [id,n] of Object.entries(json.buildings)){ if (buildingsState[id]) buildingsState[id].owned = Number(n) || 0; }
    }
    purchasedUpgrades.clear();
    if (Array.isArray(json.purchased)) json.purchased.forEach(id=>purchasedUpgrades.add(id));
    if (json.settings){
      if (typeof json.settings.volume !== 'undefined'){ volume = (Number(json.settings.volume)||80)/100; localStorage.setItem(LS_VOLUME, Math.round(volume*100)); volumeRange.value = Math.round(volume*100); }
      if (typeof json.settings.starName === 'string'){ starName = json.settings.starName || 'StarCollector'; localStorage.setItem(LS_NAME, starName); nameInput.value = starName; starNameEl.textContent = starName; }
    }
    refreshUI(); saveGame(); alert('Import successful!');
  } catch(e){ console.warn('Import apply failed', e); alert('Import failed'); }
});

// ---------- UTIL & UI HELPERS ----------
function flashButton(el){ if (!el) return; el.style.transform="translateY(-4px)"; el.style.boxShadow="0 8px 22px rgba(255,0,80,0.08)"; setTimeout(()=>{ el.style.transform=""; el.style.boxShadow=""; },220); }

// ---------- INITIAL RENDER & START ----------
renderUpgrades();
renderBuildings();
refreshUI();
clickAudio.volume = volume;

// keyboard & small UI behavior
document.addEventListener('keydown',(e)=>{ if (e.key === 'Escape'){ settingsModal.style.display='none'; settingsModal.setAttribute('aria-hidden','true'); confirmWipe.style.display='none'; } });
nameInput.addEventListener('blur', ()=>{ localStorage.setItem(LS_NAME, nameInput.value.slice(0,20) || 'StarCollector'); generateExportCode(); saveGame(); });
settingsModal.addEventListener('click',(e)=>{ if (e.target === settingsModal) { settingsModal.style.display='none'; settingsModal.setAttribute('aria-hidden','true'); } });

</script>
</body>
</html>
